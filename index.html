<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î†àÏù¥Îìú ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ - Rogue Expedition</title>
    <!-- Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap');

        body {
            background-color: #050505;
            color: #f8f8f8;
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        .font-black { font-weight: 900; }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÏùò */
        @keyframes pop-fade-up {
            0% { opacity: 0; transform: translate(-50%, 0%) scale(0.6); }
            20% { opacity: 1; transform: translate(-50%, -40px) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -100px) scale(1); }
        }
        .animate-combat-text { 
            position: absolute;
            animation: pop-fade-up 0.6s ease-out forwards; 
            pointer-events: none; 
            z-index: 100; 
        }
        
        @keyframes projectile-move {
            0% { left: var(--start-x); top: var(--start-y); opacity: 0; transform: translate(-50%, -50%) rotate(var(--angle)) scale(0.5); }
            20% { opacity: 1; }
            85% { opacity: 1; }
            100% { left: var(--end-x); top: var(--end-y); opacity: 0; transform: translate(-50%, -50%) rotate(var(--angle)) scale(1.2); }
        }
        .animate-projectile { 
            position: absolute; 
            animation: projectile-move 0.65s ease-in-out forwards; 
            z-index: 60; 
            pointer-events: none; 
        }
        
        @keyframes heal-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); background-color: rgba(34,197,94,0.3); } }
        .animate-heal-pulse { animation: heal-pulse 0.5s ease-out; }
        
        @keyframes shield-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); background-color: rgba(59,130,246,0.3); } }
        .animate-shield-pulse { animation: shield-pulse 0.5s ease-out; }

        @keyframes shake { 0%, 100% { transform: translate(0,0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-4px,-4px); } 20%, 40%, 60%, 80% { transform: translate(4px,4px); } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        .boss-breathing { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        .attack-gauge { transition: width 0.1s linear; }
        .interactive { cursor: pointer; touch-action: manipulation; }
        .strong-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,1), -1px -1px 0 rgba(0,0,0,1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- Lucide ÏïÑÏù¥ÏΩò Î∏åÎ¶øÏßÄ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconContent, setIconContent] = useState("");
            
            useEffect(() => {
                // Lucide ÏïÑÏù¥ÏΩòÏùÑ ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôòÌïòÏó¨ Î†åÎçîÎßÅ
                const svg = lucide.createIcons({
                    icons: { [name]: true },
                    attrs: { width: size, height: size, class: className }
                });
            }, [name, size, className]);

            // React Ïª¥Ìè¨ÎÑåÌä∏ ÎÇ¥ÏóêÏÑú LucideÎ•º ÏßÅÏ†ë Ïì∞Í∏∞ Ïñ¥Î†§Ïö∞ÎØÄÎ°ú SVG Ìå®Ïä§Î•º ÏßÅÏ†ë Ï†ïÏùòÌïòÍ±∞ÎÇò 
            // lucide-react ÎåÄÏã† Îã®Ïàú ÏïÑÏù¥ÏΩò Îß§ÌïëÏùÑ ÏÇ¨Ïö© (Î∞∞Ìè¨Ïö© ÏïàÏ†ïÏÑ± Ïö∞ÏÑ†)
            const iconMap = {
                Heart: "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",
                Shield: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
                Zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
                User: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
                Sword: "M14.5 17.5L3 6V3h3l11.5 11.5 M13 19l6-6 M16 16l4 4",
                Coins: "M8 8a6 6 0 1 0 0 12A6 6 0 0 0 8 8z M18 8a6 6 0 0 1-7.74 5.74 M12 18a6 6 0 0 1-5.74-7.74",
                Book: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z",
                ShoppingCart: "M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6",
                Activity: "M22 12h-4l-3 9L9 3l-3 9H2",
                Flame: "M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",
                Box: "M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z M3.3 7l8.7 5 8.7-5 M12 22V12",
                Star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
                Backpack: "M4 10V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6 M8 2v4 M16 2v4 M4 10h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-9z M9 14h6",
                Users: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75",
                Trophy: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22 M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22 M18 2H6v7a6 6 0 0 0 12 0V2z"
            };

            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d={iconMap[name] || ""}></path>
                </svg>
            );
        };

        // --- ÏÉÅÏàò Îç∞Ïù¥ÌÑ∞ ---
        const ALL_SKILLS = {
            1: { name: 'ÏàúÍ∞Ñ ÏπòÏú†', mana: 15, cd: 1.2, icon: 'Heart', desc: 'ÎåÄÏÉÅÏùÑ Ï¶âÏãú Îπ†Î•¥Í≤å ÏπòÏú†Ìï©ÎãàÎã§.' },
            2: { name: 'Ïû¨ÏÉù(HoT)', mana: 20, cd: 4, icon: 'Activity', desc: 'ÏßÄÏÜçÏ†ÅÏúºÎ°ú Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÏãúÌÇµÎãàÎã§.' },
            3: { name: 'Ïã†Ïùò Î≥¥Ìò∏Îßâ', mana: 25, cd: 7, icon: 'Shield', desc: 'ÌîºÌï¥Î•º Ìù°ÏàòÌïòÎäî Î≥¥Ìò∏ÎßâÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.' },
            4: { name: 'ÏÑ±Ïä§Îü¨Ïö¥ Ìè≠Î∞ú', mana: 50, cd: 12, icon: 'Flame', desc: 'ÌååÌã∞Ïõê Ï†ÑÏ≤¥Î•º ÎèôÏãúÏóê ÏπòÏú†Ìï©ÎãàÎã§.' },
            5: { name: 'ÏÉÅÍ∏â ÏπòÏú†', mana: 35, cd: 3.0, icon: 'Heart', desc: 'ÎäêÎ¶¨ÏßÄÎßå Îß§Ïö∞ ÌÅ∞ ÏÉùÎ™ÖÎ†•ÏùÑ ÌöåÎ≥µÌï©ÎãàÎã§.' },
            6: { name: 'Í∏∞Ï†ÅÏùò Í∏∞ÎèÑ', mana: 60, cd: 20, icon: 'Star', desc: 'ÌååÌã∞ Ï†ÑÏ≤¥Î•º Ï†ÑÏÑ§Ïùò ÌûòÏúºÎ°ú ÎåÄÌè≠ ÌöåÎ≥µÌï©ÎãàÎã§.' },
            7: { name: 'Î™ÖÏÉÅ', mana: 0, cd: 30, icon: 'Zap', desc: 'Ï¶âÏãú ÎßàÎÇòÎ•º 100 ÌöåÎ≥µÌï©ÎãàÎã§.' },
            8: { name: 'Ï≤úÏÉÅÏùò Î∞©Î≤Ω', mana: 45, cd: 15, icon: 'Shield', desc: 'ÌååÌã∞Ïõê Ï†ÑÏ≤¥ÏóêÍ≤å Í∞ïÎ†•Ìïú Î≥¥Ìò∏ÎßâÏùÑ ÏîåÏõÅÎãàÎã§.' }
        };

        const ENEMIES = [
            { name: "Í≥†Î∏îÎ¶∞ ÏàòÏÉâÎåÄ", emoji: "üë∫", hpFactor: 0.15, specialSpeed: 1.2 },
            { name: "Ï†ïÏòà Ïò§ÌÅ¨ Ï†ÑÏÇ¨", emoji: "üëπ", hpFactor: 0.45, specialSpeed: 2.0 },
            { name: "Í≥†ÎåÄ ÌùëÎ£° (BOSS)", emoji: "üê≤", hpFactor: 1.2, specialSpeed: 3.2 }
        ];

        const ITEM_POOLS = [
            { id: 'i1', name: 'ÎÖπÏä® Í≤Ä', type: 'weapon', target: 'DPS', stat: 'attack', value: 120, rarity: 'Common' },
            { id: 'i2', name: 'Í∞ïÌôî Î∞©Ìå®', type: 'weapon', target: 'Tank', stat: 'defense', value: 250, rarity: 'Common' },
            { id: 'i3', name: 'Ï∞∏ÎÇòÎ¨¥ ÏßÄÌå°Ïù¥', type: 'weapon', target: 'HEALER', stat: 'heal', value: 1.2, rarity: 'Common' },
            { id: 'i4', name: 'Î™®ÌóòÍ∞Ä Î°úÎ∏å', type: 'armor', target: 'ANY', stat: 'hp', value: 300, rarity: 'Common' },
            { id: 'i5', name: 'Î∞úÎ≠â (Î™ÖÍ≤Ä)', type: 'weapon', target: 'DPS', stat: 'attack', value: 450, rarity: 'Rare' },
            { id: 'i6', name: 'ÏÑ±Í∏∞ÏÇ¨Ïùò Í∞ëÏ£º', type: 'armor', target: 'Tank', stat: 'hp', value: 1000, rarity: 'Rare' },
            { id: 'l1', name: 'ÎìúÎûòÍ≥§ Ïä¨Î†àÏù¥Ïñ¥', type: 'weapon', target: 'DPS', stat: 'attack', value: 950, rarity: 'Legendary' },
            { id: 'l2', name: 'Î∂àÎ©∏Ïùò Î∞©Ìå®', type: 'weapon', target: 'Tank', stat: 'defense', value: 1800, rarity: 'Legendary' },
            { id: 'l3', name: 'ÎåÄÏ≤úÏÇ¨Ïùò ÏÑ±Î¨º', type: 'weapon', target: 'HEALER', stat: 'heal', value: 1.8, rarity: 'Legendary' },
            { id: 'l4', name: 'Ïö©Ïùò ÎπÑÎäò Í∞ëÏò∑', type: 'armor', target: 'ANY', stat: 'hp', value: 2500, rarity: 'Legendary' }
        ];

        const UPGRADE_CARDS = [
            { id: 'u1', name: 'ÏÉùÎ™ÖÏùò ÌùêÎ¶Ñ', desc: 'ÏπòÏú† Ìö®Ïú® +25%', icon: 'Heart', color: 'text-green-400' },
            { id: 'u2', name: 'ÎßàÎÇòÏùò ÏÉò', desc: 'ÎßàÎÇò Ïû¨ÏÉù +35%', icon: 'Zap', color: 'text-blue-400' },
            { id: 'u3', name: 'Ï≤†Î≤ΩÏùò Í∞ÄÌò∏', desc: 'Î≥¥Ìò∏Îßâ Í∞ïÎèÑ +30%', icon: 'Shield', color: 'text-cyan-400' },
            { id: 'u4', name: 'Ïã†ÏÜçÌïú Í∏∞ÎèÑ', desc: 'Ïä§ÌÇ¨ Ïø®Îã§Ïö¥ -20%', icon: 'Activity', color: 'text-yellow-400' },
            { id: 'u5', name: 'Ïò§Î≤ÑÌûê Ï∂ïÎ≥µ', desc: 'Ï¥àÍ≥º ÏπòÏú†Ïùò 25%Î•º Î≥¥Ìò∏ÎßâÏúºÎ°ú', icon: 'Star', color: 'text-purple-400' }
        ];

        const UNIT_COORD = {
            boss: { x: 50, y: 22 },
            'p-0': { x: 15, y: 78 },
            'p-1': { x: 38, y: 78 },
            'p-2': { x: 62, y: 78 },
            'p-player': { x: 85, y: 78 }
        };

        // --- ÏÑúÎ∏å Ïª¥Ìè¨ÎÑåÌä∏ Ï†ïÏùò ---

        const LobbyView = ({ player, setView, setDifficulty, difficulty, startRaid }) => (
            <div className="max-w-2xl mx-auto space-y-6 pt-10 px-4 pb-20 font-black">
                <div className="bg-neutral-900 rounded-[3rem] p-8 border-4 border-neutral-800 shadow-2xl relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-5 rotate-12"><Icon name="Sword" size={120} /></div>
                    <h1 className="text-4xl italic text-blue-500 uppercase tracking-tighter mb-4 shadow-blue-900">Expedition HQ</h1>
                    <div className="flex items-end gap-2 mb-2"><span className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Level</span><span className="text-5xl text-white font-black">{player.level}</span></div>
                    <div className="w-full bg-neutral-800 h-4 rounded-full overflow-hidden mb-2 border border-neutral-700 shadow-inner">
                        <div className="h-full bg-blue-600 transition-all" style={{ width: `${(player.exp/player.nextLevelExp)*100}%` }} />
                    </div>
                    <div className="flex justify-between text-[11px] text-neutral-400 font-bold">
                        <span>EXP: {player.exp} / {player.nextLevelExp}</span>
                        <span className="text-yellow-400 flex items-center gap-1 font-black"><Icon name="Coins" size={14} /> {player.gold} Gold</span>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => setView('SKILLS')} className="interactive flex items-center gap-4 p-6 bg-neutral-900 rounded-[2rem] border-2 border-neutral-800 hover:border-blue-500 transition-all shadow-xl active:scale-95 font-bold">
                        <div className="p-3 bg-blue-500/20 text-blue-400 rounded-2xl"><Icon name="Book" size={24} /></div>
                        <div className="text-left font-black"><div className="text-lg text-white">Í∏∞Ïà† Ïó∞Îßà</div><div className="text-xs text-neutral-500 uppercase">Skill Shop</div></div>
                    </button>
                    <button onClick={() => setView('PARTY')} className="interactive flex items-center gap-4 p-6 bg-neutral-900 rounded-[2rem] border-2 border-neutral-800 hover:border-emerald-500 transition-all shadow-xl active:scale-95 font-bold">
                        <div className="p-3 bg-emerald-500/20 text-emerald-400 rounded-2xl font-black"><Icon name="Backpack" size={24} /></div>
                        <div className="text-left font-black"><div className="text-lg text-white">ÌååÌã∞ Í¥ÄÎ¶¨</div><div className="text-xs text-neutral-500 uppercase tracking-widest">Inventory</div></div>
                    </button>
                </div>

                <div className="space-y-4 pt-4 font-black">
                    <div className="flex gap-2 p-2 bg-neutral-900 rounded-[1.5rem] border-2 border-neutral-800">
                        {['EASY', 'NORMAL', 'HARD'].map(d => (
                            <button key={d} onClick={() => setDifficulty(d)} className={`flex-1 py-3 rounded-2xl text-xs font-black transition-all ${difficulty === d ? 'bg-blue-600 text-white shadow-lg' : 'text-neutral-400 hover:bg-neutral-800'}`}>{d}</button>
                        ))}
                    </div>
                    <button onClick={() => startRaid(difficulty)} className="interactive w-full py-8 bg-blue-600 hover:bg-blue-500 rounded-[3rem] text-3xl italic uppercase shadow-blue-600/30 shadow-2xl transition-all active:scale-95 flex items-center justify-center gap-4 font-black">
                        Enter Dungeon <Icon name="Activity" size={32} />
                    </button>
                </div>
            </div>
        );

        const RaidView = ({ raidData, combatEffects, projectiles, player, selectedTarget, setSelectedTarget, castSpell, logs, flashes }) => (
            <div className="max-w-4xl mx-auto space-y-6 pt-10 px-4 pb-24 relative font-black">
                <div className="relative w-full aspect-[4/5] sm:aspect-[4/3] min-h-[580px] flex flex-col justify-between p-8 rounded-[3.5rem] border-4 border-neutral-900 bg-neutral-900/10 shadow-inner overflow-visible">
                    <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 px-6 py-2 rounded-full border border-neutral-700 font-black italic tracking-widest text-xs z-[80] text-blue-400 uppercase shadow-lg">
                        Area {raidData.stage} / {raidData.maxStages}
                    </div>
                    <div className="absolute inset-0 pointer-events-none z-[70] overflow-visible">
                        {projectiles.map(p => (
                            <div key={p.id} className="animate-projectile" style={{
                                '--start-x': `${p.start.x}%`, '--start-y': `${p.start.y}%`, 
                                '--end-x': `${p.end.x}%`, '--end-y': `${p.end.y}%`, 
                                '--angle': `${p.angle}deg`
                            }}>
                                <div className={p.effectType === 'boss' ? "w-10 h-10 bg-red-600 rounded-full shadow-[0_0_30px_#ef4444]" : "w-14 h-1.5 bg-yellow-300 rounded-full"} />
                            </div>
                        ))}
                        {combatEffects.map(e => (
                            <div key={e.id} className="animate-combat-text font-black text-5xl" style={{
                                left: `${UNIT_COORD[e.targetId].x}%`, 
                                top: `${UNIT_COORD[e.targetId].y}%`, 
                                color: e.type === 'damage' ? '#ef4444' : e.type === 'shield' ? '#60a5fa' : '#4ade80',
                            }}>
                                {e.value}
                            </div>
                        ))}
                    </div>

                    <div className="w-full flex flex-col items-center pt-10 z-10 font-black">
                        <div className={`text-[8rem] sm:text-[10rem] boss-breathing transition-all ${raidData.bossSpecialProgress >= 90 ? 'brightness-150 drop-shadow-[0_0_40px_#ef4444]' : ''}`}>
                           {ENEMIES[raidData.stage - 1].emoji}
                        </div>
                        <h3 className="text-white text-xl font-black mb-2 italic uppercase tracking-tighter">{ENEMIES[raidData.stage - 1].name}</h3>
                        <div className="w-full max-w-sm bg-neutral-950 h-5 rounded-full border-2 border-neutral-800 overflow-hidden shadow-inner mb-3">
                            <div className="h-full bg-gradient-to-r from-red-800 to-red-600 transition-all duration-300" style={{ width: `${(raidData.bossHp/raidData.bossMaxHp)*100}%` }} />
                        </div>
                        <div className="w-full max-w-sm flex gap-2 px-1">
                            <div className="flex-1 bg-neutral-950 h-3 rounded-full overflow-hidden shadow-inner border border-neutral-800"><div className="h-full bg-red-500 attack-gauge" style={{ width: `${raidData.bossAttackProgress}%` }} /></div>
                            <div className="flex-1 bg-neutral-950 h-3 rounded-full overflow-hidden shadow-inner border border-neutral-800"><div className="h-full bg-purple-600 attack-gauge shadow-[0_0_15px_#a855f7]" style={{ width: `${raidData.bossSpecialProgress}%` }} /></div>
                        </div>
                        <div className="text-sm font-black text-red-500 mt-2 tracking-widest">{Math.ceil(raidData.bossHp).toLocaleString()} HP</div>
                    </div>

                    <div className="w-full grid grid-cols-4 gap-3 sm:gap-4 z-10 font-black font-black">
                        {raidData.party.map((m, i) => (
                            <div key={i} onClick={() => m.curHp > 0 && setSelectedTarget(i)} className={`interactive relative p-3 sm:p-4 rounded-[2.5rem] border-2 transition-all h-32 sm:h-44 flex flex-col justify-center text-center shadow-lg ${m.curHp <= 0 ? 'bg-black opacity-20 border-neutral-900' : selectedTarget === i ? 'bg-blue-900/40 border-blue-500 scale-105 shadow-blue-500/20' : 'bg-neutral-900 border-neutral-800'} ${flashes[`p-${i}`] === 'heal' ? 'animate-heal-pulse' : flashes[`p-${i}`] === 'shield' ? 'animate-shield-pulse' : ''} ${m.shield > 0 ? 'ring-4 ring-blue-500/40' : ''}`}>
                                {m.curHp <= 0 && <div className="absolute inset-0 flex items-center justify-center z-[20] text-red-500 font-black text-xl italic uppercase">Dead</div>}
                                {m.hot > 0 && <div className="absolute top-2 right-2 animate-pulse"><Icon name="Activity" className="text-green-400" /></div>}
                                <div className="text-3xl sm:text-4xl pointer-events-none mb-2">{m.emoji}</div>
                                <div className="text-[9px] sm:text-[10px] font-black uppercase text-neutral-400 mb-1">{m.name}</div>
                                <div className="w-full bg-neutral-950 h-3 rounded-full overflow-hidden border border-neutral-800 shadow-inner mb-1 relative">
                                    {m.shield > 0 && <div className="absolute h-full bg-cyan-400/80 transition-all shadow-[0_0_10px_#22d3ee]" style={{ width: `${(m.shield/m.maxHp)*100}%`, left: `${(m.curHp/m.maxHp)*100}%`, zIndex: 5 }} />}
                                    <div className="h-full bg-green-600 transition-all" style={{ width: `${(m.curHp/m.maxHp)*100}%` }} />
                                </div>
                                <div className="w-full bg-neutral-950 h-1.5 rounded-full overflow-hidden border border-neutral-800"><div className="h-full bg-yellow-500 attack-gauge" style={{ width: `${m.attackProgress}%` }} /></div>
                            </div>
                        ))}
                        <div onClick={() => setSelectedTarget(3)} className={`interactive relative p-3 sm:p-4 rounded-[2.5rem] border-2 transition-all h-32 sm:h-44 flex flex-col justify-center text-center shadow-lg font-black ${selectedTarget === 3 ? 'bg-blue-900/40 border-blue-500 scale-105 shadow-blue-500/30' : 'bg-blue-950/20 border-blue-900/40'} ${flashes['p-player'] === 'heal' ? 'animate-heal-pulse' : flashes['p-player'] === 'shield' ? 'animate-shield-pulse' : ''} ${raidData.playerShield > 0 ? 'ring-4 ring-blue-500/40' : ''}`}>
                            <div className="text-3xl sm:text-4xl mb-2 font-black">üßô</div>
                            <div className="text-[9px] sm:text-[10px] font-black uppercase text-blue-400 mb-1 italic tracking-widest font-black">HEALER</div>
                            <div className="w-full bg-neutral-950 h-3 rounded-full overflow-hidden border border-neutral-800 shadow-inner relative">
                                {raidData.playerShield > 0 && <div className="absolute h-full bg-cyan-400/80 transition-all shadow-[0_0_10px_#22d3ee]" style={{ width: `${(raidData.playerShield/player.maxHp)*100}%`, left: `${(raidData.playerCurHp/player.maxHp)*100}%`, zIndex: 5 }} />}
                                <div className="h-full bg-blue-600 transition-all" style={{ width: `${(raidData.playerCurHp/player.maxHp)*100}%` }} />
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-neutral-900 p-6 rounded-[3rem] border-2 border-neutral-800 flex flex-col lg:flex-row gap-6 shadow-2xl font-black">
                    <div className="flex-1 space-y-4">
                        <div className="flex justify-between items-center text-xs font-black text-blue-300 uppercase tracking-widest italic"><span>Mana Status</span><span>{Math.floor(raidData.mana)} / {raidData.maxMana}</span></div>
                        <div className="w-full bg-neutral-950 h-4 rounded-full overflow-hidden shadow-inner border border-neutral-800"><div className="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_15px_#2563eb]" style={{ width: `${(raidData.mana/raidData.maxMana)*100}%` }} /></div>
                        <div className="grid grid-cols-4 gap-3">
                            {player.equippedSkills.map(sid => {
                                const s = ALL_SKILLS[sid];
                                const cd = raidData.cooldowns[sid];
                                return (
                                    <button key={sid} onClick={() => castSpell(sid)} disabled={cd > 0} className={`interactive relative aspect-square rounded-2xl border-2 flex flex-col items-center justify-center gap-1 transition-all ${cd > 0 ? 'bg-black border-neutral-900 opacity-40' : 'bg-neutral-800 border-neutral-700 hover:border-blue-500 active:scale-90 shadow-lg'}`}>
                                        <Icon name={s.icon} className="text-white" size={20} />
                                        <span className="text-[9px] sm:text-[10px] font-bold text-center text-white px-1 truncate w-full italic">{s.name}</span>
                                        {cd > 0 && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-xl font-black italic text-white">{(cd/10).toFixed(1)}</div>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                    <div className="w-full lg:w-80 bg-black/60 rounded-2xl p-4 border border-neutral-800 h-44 flex flex-col shadow-inner">
                        <span className="text-[10px] font-black text-neutral-400 uppercase border-b border-neutral-800 pb-2 mb-2 italic tracking-widest">Tactical Feed</span>
                        <div className="flex-1 overflow-y-auto space-y-1 text-[11px] font-mono tracking-tighter text-neutral-300">
                            {logs.map(l => <div key={l.id} className={l.type==='error'?'text-red-400 font-bold':l.type==='success'?'text-blue-400 font-bold':'text-neutral-400'}>{l.msg}</div>)}
                        </div>
                    </div>
                </div>
            </div>
        );

        const LootOverlay = ({ upgrades, items, gold, onSelectUpgrade }) => (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/85 backdrop-blur-2xl p-6 font-black font-black">
                <div className="w-full max-w-4xl text-center space-y-10 font-black font-black">
                    <div>
                        <h2 className="text-6xl italic text-yellow-400 mb-2 uppercase tracking-tighter font-black">Area Secured!</h2>
                        <div className="flex items-center justify-center gap-8 text-neutral-400 text-lg font-black uppercase tracking-widest">
                            <span className="text-yellow-500 flex items-center gap-1"><Icon name="Coins" size={22}/> +{gold} Gold</span>
                            <span className="text-blue-400 flex items-center gap-1"><Icon name="Box" size={22}/> Loot Secured</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10 font-black">
                        <div className="bg-neutral-900/60 p-8 rounded-[3.5rem] border-2 border-neutral-800 font-black">
                            <h3 className="text-xs uppercase tracking-[0.4em] text-neutral-500 mb-6 font-black">Final Boss Loot</h3>
                            <div className="space-y-4 font-black">
                                {items.map((it, idx) => (
                                    <div key={idx} className={`p-6 rounded-3xl flex justify-between items-center border ${it.rarity === 'Legendary' ? 'bg-yellow-900/20 border-yellow-500 animate-pulse' : 'bg-black/60 border-neutral-700/50'}`}>
                                        <div className="flex items-center gap-4"><div className={`p-3 rounded-xl ${it.rarity === 'Legendary' ? 'bg-yellow-600 text-black' : 'bg-neutral-800 text-yellow-400'}`}><Icon name="Sword" size={24}/></div><div className="text-left font-black"><div className={`text-lg ${it.rarity === 'Legendary' ? 'text-yellow-400' : 'text-white'}`}>{it.name}</div><div className="text-[10px] text-neutral-500 uppercase">{it.rarity} Gear</div></div></div>
                                        <div className="text-base text-blue-400 font-bold">+{it.value}{it.stat === 'heal' ? 'x' : ''}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="space-y-4 font-black">
                            <h3 className="text-xs uppercase tracking-[0.4em] text-neutral-500 mb-6 font-black">Choose Boon</h3>
                            <div className="grid grid-cols-1 gap-4 font-black">
                                {upgrades.map(card => (
                                    <button key={card.id} onClick={() => onSelectUpgrade(card)} className="interactive group bg-neutral-900 p-6 rounded-[3rem] border-2 border-neutral-800 hover:border-yellow-500 flex items-center gap-5 transition-all shadow-xl font-black">
                                        <div className={`p-4 bg-neutral-800 rounded-2xl group-hover:scale-110 transition-transform ${card.color}`}><Icon name={card.icon} size={28} /></div>
                                        <div className="text-left font-black font-black"><div className="text-white text-lg font-black">{card.name}</div><div className="text-neutral-500 text-xs font-black">{card.desc}</div></div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const PartyGearView = ({ party, inventory, setView, onEquip, onUnequip }) => (
            <div className="max-w-4xl mx-auto pt-10 space-y-8 font-bold px-4 pb-20 font-black font-black font-black font-black font-black">
                <button onClick={() => setView('LOBBY')} className="text-neutral-500 hover:text-white flex items-center gap-2 uppercase tracking-widest font-black font-black">&larr; Return to HQ</button>
                <h2 className="text-4xl italic text-emerald-500 border-l-8 border-emerald-500 pl-4 uppercase font-black tracking-tighter">Party Gear</h2>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-10 font-black">
                    <div className="space-y-4 font-black">
                    {party.map((m, mIdx) => (
                        <div key={mIdx} className="bg-neutral-900 p-6 rounded-[3rem] border-4 border-neutral-800 shadow-2xl font-black font-black">
                            <div className="flex items-center gap-4 mb-6 font-black font-black">
                            <span className="text-5xl font-black">{m.emoji}</span>
                            <div className="font-black"><div className="text-xl text-white font-black">{m.name}</div><div className="text-xs text-neutral-500 uppercase font-black">{m.role}</div></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 font-black">
                            {['weapon', 'armor'].map(type => (
                                <div key={type} className="bg-black/40 p-4 rounded-3xl border border-neutral-700 flex flex-col items-center gap-3 font-black">
                                    <div className="text-[10px] text-neutral-500 uppercase font-black">{type}</div>
                                    {m.equipment[type] ? (
                                    <>
                                        <div className={`text-sm text-center font-black ${m.equipment[type].rarity === 'Legendary' ? 'text-yellow-400' : 'text-blue-400'}`}>{m.equipment[type].name}</div>
                                        <button onClick={() => onUnequip(m.id, type)} className="text-[11px] text-red-500 hover:bg-red-950/30 px-3 py-1.5 rounded-full border border-red-900/50 font-black transition-all">Unequip</button>
                                    </>
                                    ) : <div className="text-xs text-neutral-700 font-black">Empty Slot</div>}
                                </div>
                            ))}
                            </div>
                        </div>
                    ))}
                    </div>
                    <div className="bg-neutral-900 p-8 rounded-[3.5rem] border-4 border-neutral-800 shadow-2xl h-fit font-black">
                    <h3 className="text-xs uppercase tracking-[0.4em] text-neutral-500 mb-8 font-black">Vault Storage ({inventory.length})</h3>
                    <div className="space-y-3 max-h-[600px] overflow-y-auto pr-2 scrollbar-hide font-black font-black">
                        {inventory.length === 0 ? <div className="text-center py-20 text-neutral-700 font-black font-black">Vault is currently empty.</div> : 
                        inventory.map((it, idx) => (
                            <div key={idx} className={`p-5 rounded-3xl border-2 flex justify-between items-center transition-all ${it.rarity === 'Legendary' ? 'bg-yellow-950/20 border-yellow-500 shadow-yellow-900/10' : 'bg-black/40 border-neutral-700'}`}>
                                <div className="text-left font-black">
                                <div className={`text-base font-black ${it.rarity === 'Legendary' ? 'text-yellow-400' : 'text-white'}`}>{it.name}</div>
                                <div className="text-[10px] text-neutral-500 uppercase font-black">{it.rarity} | Suitable: {it.target}</div>
                                </div>
                                <div className="flex gap-1 font-black">
                                {[0,1,2,3].map(pIdx => (
                                    <button key={pIdx} onClick={() => onEquip(pIdx, it, idx)} className="w-9 h-9 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black transition-all shadow-lg">P{pIdx+1}</button>
                                ))}
                                </div>
                            </div>
                        ))
                        }
                    </div>
                    </div>
                </div>
            </div>
        );

        const SkillMenuView = ({ player, setPlayer, setView, equipSkill }) => (
            <div className="max-w-4xl mx-auto pt-10 space-y-8 font-bold px-4 pb-20 font-black font-black font-black font-black font-black">
                <button onClick={() => setView('LOBBY')} className="text-neutral-500 hover:text-white flex items-center gap-2 uppercase tracking-widest font-black font-black">&larr; Return to Base</button>
                <h2 className="text-4xl italic text-blue-500 border-l-8 border-blue-500 pl-4 uppercase font-black tracking-tighter font-black font-black">Ability Arsenal</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 font-black">
                    <div className="bg-neutral-900 p-6 rounded-[2rem] border-2 border-neutral-800 space-y-4 h-fit shadow-xl font-black font-black">
                    <h3 className="text-xs uppercase tracking-widest text-neutral-500 italic font-black">Active Shortcuts</h3>
                    {player.equippedSkills.map((sid, i) => (
                        <div key={i} className="flex items-center gap-4 p-4 bg-black/40 rounded-2xl border border-blue-900/30 font-black">
                            <span className="text-xs text-neutral-600 font-mono font-black">#{i+1}</span>
                            <div className="text-blue-400 font-black"><Icon name={ALL_SKILLS[sid].icon} size={18} /></div>
                            <div className="text-sm truncate text-white font-black font-black">{ALL_SKILLS[sid].name}</div>
                        </div>
                    ))}
                    </div>
                    <div className="md:col-span-2 space-y-4 max-h-[70vh] overflow-y-auto pr-2 scrollbar-hide font-black">
                    {Object.entries(ALL_SKILLS).map(([id, s]) => {
                        const sid = Number(id);
                        const isEquipped = player.equippedSkills.includes(sid);
                        const level = player.skillLevels[sid] || 0;
                        return (
                        <div key={id} className={`p-6 rounded-[2rem] border-2 transition-all shadow-lg font-black font-black font-black ${isEquipped ? 'bg-blue-900/10 border-blue-500 font-black' : 'bg-neutral-900 border-neutral-800 font-black font-black'}`}>
                            <div className="flex justify-between items-center font-black">
                                <div className="flex items-center gap-5">
                                <div className="p-4 bg-neutral-800 rounded-2xl text-blue-400 font-black font-black"><Icon name={s.icon} size={28} /></div>
                                <div className="font-black"><div className="text-xl font-black text-white font-black font-black font-black">{s.name} <span className="text-sm text-blue-500 ml-2 font-black">Lv.{level}</span></div><div className="text-xs text-neutral-500 mt-1 font-black font-black">{s.desc}</div></div>
                                </div>
                                <div className="flex flex-col gap-2 font-black">
                                <button onClick={() => setPlayer(p => ({...p, skillPoints: p.skillPoints - 1, skillLevels: {...p.skillLevels, [sid]: level + 1}}))} disabled={player.skillPoints <= 0} className="px-4 py-2 bg-blue-600 rounded-xl text-xs hover:bg-blue-500 disabled:opacity-30 text-white font-black font-black">UPGRADE</button>
                                {level > 0 && (
                                    <div className="flex gap-1 font-black">
                                    {[0,1,2,3].map(slot => (
                                        <button key={slot} onClick={() => equipSkill(sid, slot)} className={`w-8 h-8 rounded-lg text-[10px] border transition-all font-black font-black ${player.equippedSkills[slot] === sid ? 'bg-white text-black border-white shadow-md' : 'bg-neutral-800 border-neutral-700 text-neutral-400'}`}>{slot+1}</button>
                                    ))}
                                    </div>
                                )}
                                </div>
                            </div>
                        </div>
                        )
                    })}
                    </div>
                </div>
            </div>
        );

        const ResultView = ({ battleResult, claimRewards }) => (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 w-full max-w-2xl mx-auto space-y-8 pt-20 text-center font-black font-black font-black font-black font-black">
                <div className={`p-12 rounded-[5rem] border-8 shadow-2xl font-black font-black font-black ${battleResult.win ? 'bg-blue-900/30 border-blue-500 shadow-blue-500/40' : 'bg-red-900/30 border-red-500 shadow-red-500/40'}`}>
                <div className="flex justify-center mb-8 font-black font-black font-black font-black font-black">{battleResult.win ? <Icon name="Trophy" size={140} className="text-yellow-400 animate-bounce" /> : <Icon name="Skull" size={140} className="text-red-500" />}</div>
                <h1 className={`text-7xl font-black italic uppercase mb-10 ${battleResult.win ? 'text-blue-400' : 'text-red-500'} strong-shadow font-black font-black`}>{battleResult.win ? 'MISSION CLEAR' : 'EXPEDITION FAILED'}</h1>
                {battleResult.win && battleResult.loot && (
                    <div className="bg-black/60 p-10 rounded-[3rem] border-2 border-neutral-800 shadow-inner mb-12 font-black font-black font-black">
                    <h3 className="text-sm font-black text-yellow-500 uppercase tracking-[0.6em] mb-10 font-black font-black">Final Legendary Loot</h3>
                    <div className="space-y-6 font-black font-black font-black font-black">
                        {battleResult.loot.map((it, i) => (
                            <div key={i} className="flex items-center justify-center gap-8 bg-neutral-900 p-6 rounded-[2.5rem] border-2 border-yellow-500 shadow-xl font-black">
                            <div className="p-4 bg-yellow-600 rounded-2xl text-black font-black"><Icon name="Star" size={36}/></div>
                            <div className="text-left font-black">
                                <div className="text-yellow-400 text-3xl font-black font-black font-black">{it.name}</div>
                                <div className="text-[14px] text-neutral-400 uppercase font-black font-black">{it.rarity} {it.type} gear</div>
                            </div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-12 pt-10 border-t border-neutral-800 flex justify-between items-center text-3xl font-black font-black">
                        <span className="text-neutral-500 uppercase italic font-black font-black">MISSION TIME</span>
                        <span className="text-white font-black font-black font-black font-black">{battleResult.stats.duration}s</span>
                    </div>
                    </div>
                )}
                <button onClick={claimRewards} className="interactive w-full py-12 bg-white text-black font-black rounded-[3.5rem] text-4xl hover:bg-neutral-200 transition-all active:scale-95 uppercase tracking-tighter italic shadow-white/10 font-black font-black font-black font-black">Finalize Quest</button>
                </div>
            </div>
        );

        // --- Î©îÏù∏ App Ïª¥Ìè¨ÎÑåÌä∏ ---

        function App() {
            const [view, setView] = useState('LOBBY');
            const [difficulty, setDifficulty] = useState('NORMAL');
            const [selectedTarget, setSelectedTarget] = useState(0);
            const [isShaking, setIsShaking] = useState(false);
            const [screenFlash, setScreenFlash] = useState(false);
            const [flashes, setFlashes] = useState({});
            const [showLoot, setShowLoot] = useState(false);
            const [randomUpgrades, setRandomUpgrades] = useState([]);
            const [lootedItems, setLootedItems] = useState([]);
            const [lootedGold, setLootedGold] = useState(0);

            const [party, setParty] = useState([
                { id: 0, name: 'TANK-KIM', role: 'Tank', emoji: 'üõ°Ô∏è', relationship: 50, equipment: { weapon: null, armor: null }, maxHp: 1200 },
                { id: 1, name: 'DPS-LEE', role: 'DPS', emoji: 'üó°Ô∏è', relationship: 50, equipment: { weapon: null, armor: null }, maxHp: 600 },
                { id: 2, name: 'DPS-PARK', role: 'DPS', emoji: 'ü™Ñ', relationship: 50, equipment: { weapon: null, armor: null }, maxHp: 600 },
            ]);

            const [player, setPlayer] = useState({
                level: 1, exp: 0, nextLevelExp: 100, gold: 500, skillPoints: 10,
                hp: 600, maxHp: 600, skillLevels: { 1: 1, 2: 1, 3: 1, 4: 1, 5: 0, 6: 0, 7: 0, 8: 0 },
                equippedSkills: [1, 2, 3, 4], equipment: { weapon: null, armor: null },
                buffs: { healMult: 1, manaRegenMult: 1, cdReduction: 0, shieldMult: 1, overhealToShield: false }
            });

            const [inventory, setInventory] = useState([]);
            const [raidData, setRaidData] = useState(null);
            const [combatEffects, setCombatEffects] = useState([]);
            const [projectiles, setProjectiles] = useState([]);
            const [logs, setLogs] = useState([]);
            const [battleResult, setBattleResult] = useState(null);

            const gameLoopRef = useRef(null);
            const statsRef = useRef({ totalHeal: 0, totalDamageTaken: 0, manaSpent: 0, startTime: 0 });

            const addLog = useCallback((msg, type = "normal") => {
                setLogs(prev => [{ msg, type, id: Math.random() }, ...prev].slice(0, 15));
            }, []);

            const triggerEffect = useCallback((targetId, value, type) => {
                const id = `eff-${Date.now()}-${Math.random()}`;
                setCombatEffects(prev => [...prev, { id, targetId, value, type }]);
                setTimeout(() => setCombatEffects(prev => prev.filter(e => e.id !== id)), 650); 
            }, []);

            const triggerFlash = useCallback((targetKey, type) => {
                setFlashes(prev => ({ ...prev, [targetKey]: type }));
                setTimeout(() => setFlashes(prev => ({ ...prev, [targetKey]: null })), 500);
            }, []);

            const triggerProjectile = useCallback((from, to, effectType) => {
                const id = `proj-${Date.now()}-${Math.random()}`;
                const start = UNIT_COORD[from]; const end = UNIT_COORD[to];
                const dx = end.x - start.x; const dy = end.y - start.y;
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                setProjectiles(prev => [...prev, { id, start, end, angle, effectType }]);
                setTimeout(() => setProjectiles(prev => prev.filter(p => p.id !== id)), 650);
            }, []);

            const triggerShake = useCallback(() => {
                setIsShaking(true); setScreenFlash(true);
                setTimeout(() => { setIsShaking(false); setScreenFlash(false); }, 400);
            }, []);

            const endRaid = useCallback((win, finalLoot = []) => {
                clearInterval(gameLoopRef.current);
                const duration = ((Date.now() - statsRef.current.startTime) / 1000).toFixed(1);
                setBattleResult({ win, stats: { ...statsRef.current, duration }, loot: finalLoot });
                setView('RESULT'); setRaidData(null);
            }, []);

            const handleMonsterDefeated = (currentStage) => {
                clearInterval(gameLoopRef.current);
                const gold = Math.floor(Math.random() * 100) + (currentStage * 250);
                const upgrades = [...UPGRADE_CARDS].sort(() => 0.5 - Math.random()).slice(0, 3);
                const items = [ITEM_POOLS[Math.floor(Math.random() * 6)]];
                
                setLootedGold(gold);
                setLootedItems(items);
                setRandomUpgrades(upgrades);
                setShowLoot(true);
            };

            const applyUpgradeAndLoot = (card) => {
                setPlayer(p => {
                    const b = { ...p.buffs };
                    if (card.id === 'u1') b.healMult += 0.25;
                    if (card.id === 'u2') b.manaRegenMult += 0.35;
                    if (card.id === 'u3') b.shieldMult += 0.3;
                    if (card.id === 'u4') b.cdReduction += 1.8;
                    if (card.id === 'u5') b.overhealToShield = true;
                    return { ...p, buffs: b, gold: p.gold + lootedGold };
                });
                setInventory(prev => [...prev, ...lootedItems]);
                setShowLoot(false);

                setRaidData(prev => {
                    const nextStage = prev.stage + 1;
                    const baseHp = { EASY: 15000, NORMAL: 30000, HARD: 80000 }[difficulty];
                    addLog(`Next: ${ENEMIES[nextStage-1].name}`, "success");
                    return {
                        ...prev, stage: nextStage,
                        bossHp: baseHp * ENEMIES[nextStage-1].hpFactor,
                        bossMaxHp: baseHp * ENEMIES[nextStage-1].hpFactor,
                        bossAttackProgress: 0, bossSpecialProgress: 0
                    };
                });
            };

            const equipItem = (pIdx, item, invIdx) => {
                if (pIdx === 3) {
                    setPlayer(prev => {
                        const current = prev.equipment[item.type];
                        if (current) setInventory(old => [...old, current]);
                        return {...prev, equipment: {...prev.equipment, [item.type]: item}};
                    });
                } else {
                    setParty(prev => {
                        const next = [...prev];
                        const current = next[pIdx].equipment[item.type];
                        if (current) setInventory(old => [...old, current]);
                        next[pIdx].equipment[item.type] = item;
                        return next;
                    });
                }
                setInventory(prev => prev.filter((_, i) => i !== invIdx));
            };

            const unequipItem = (pId, type) => {
                if (pId === 3) {
                    setPlayer(prev => {
                        const removed = prev.equipment[type];
                        if (!removed) return prev;
                        setInventory(old => [...old, removed]);
                        return { ...prev, equipment: { ...prev.equipment, [type]: null } };
                    });
                } else {
                    setParty(prev => prev.map(m => {
                        if (m.id === pId) {
                            const removed = m.equipment[type];
                            if (!removed) return m;
                            setInventory(old => [...old, removed]);
                            return { ...m, equipment: { ...m.equipment, [type]: null } };
                        }
                        return m;
                    }));
                }
            };

            const equipSkill = useCallback((sid, slot) => {
                setPlayer(prev => {
                    const next = [...prev.equippedSkills];
                    if (next.includes(sid)) {
                        const oldIdx = next.indexOf(sid);
                        const temp = next[slot]; next[slot] = sid; next[oldIdx] = temp;
                    } else { next[slot] = sid; }
                    return { ...prev, equippedSkills: next };
                });
            }, []);

            const startRaidSession = (diff) => {
                const baseHp = { EASY: 15000, NORMAL: 30000, HARD: 80000 }[diff];
                setDifficulty(diff);
                statsRef.current = { totalHeal: 0, totalDamageTaken: 0, manaSpent: 0, startTime: Date.now() };
                setRaidData({
                    stage: 1, maxStages: 3, 
                    bossHp: baseHp * ENEMIES[0].hpFactor, bossMaxHp: baseHp * ENEMIES[0].hpFactor, 
                    mana: 200, maxMana: 200,
                    cooldowns: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0 },
                    party: party.map(m => ({ ...m, curHp: m.maxHp, shield: 0, hot: 0, attackProgress: 0 })),
                    playerCurHp: 600, playerMaxHp: 600, playerShield: 0, bossAttackProgress: 0, bossSpecialProgress: 0
                });
                setView('RAID');
                addLog(`Dungeon entry. Targeting: ${ENEMIES[0].name}`, "success");
            };

            const castSpell = useCallback((skillId) => {
                setRaidData(prev => {
                    if (!prev || showLoot) return prev;
                    const skill = ALL_SKILLS[skillId];
                    const level = player.skillLevels[skillId] || 1;
                    const weaponBonus = (player.equipment.weapon?.stat === 'heal' ? player.equipment.weapon.value : 1.0);
                    const bonus = weaponBonus * player.buffs.healMult;
                    
                    if (prev.mana < skill.mana || prev.cooldowns[skillId] > 0) return prev;
                    
                    const next = { ...prev };
                    next.mana -= skill.mana; next.cooldowns[skillId] = skill.cd * 10;
                    const hAmt = (skillId === 1 ? 220 : skillId === 5 ? 550 : 150) * (1 + (level-1) * 0.2) * bonus;
                    
                    addLog(`${skill.name} Î∞úÎèô!`, "success");

                    const resolveHeal = (curHp, maxHp, amt, shieldState) => {
                        if (curHp <= 0) return { h: 0, s: shieldState }; 
                        let newHp = Math.min(maxHp, curHp + amt);
                        let newShield = shieldState;
                        if (player.buffs.overhealToShield && (curHp + amt) > maxHp) {
                            const over = (curHp + amt) - maxHp;
                            newShield = Math.min(maxHp * 0.6, newShield + (over * 0.25));
                        }
                        return { h: newHp, s: newShield };
                    };

                    if ([1, 2, 5].includes(skillId)) {
                        const targetKey = selectedTarget === 3 ? 'p-player' : `p-${selectedTarget}`;
                        if (selectedTarget !== 3 && next.party[selectedTarget].curHp <= 0) { addLog("ÏÇ¨ÎßùÌïú ÏïÑÍµ∞ÏùÄ ÏπòÏú†Ìï† Ïàò ÏóÜÏäµÎãàÎã§.", "error"); return prev; }
                        triggerFlash(targetKey, 'heal');
                        if (selectedTarget === 3) {
                            const res = resolveHeal(next.playerCurHp, next.playerMaxHp, hAmt, next.playerShield);
                            next.playerCurHp = res.h; next.playerShield = res.s;
                        } else {
                            if (skillId === 2) next.party[selectedTarget].hot = 12;
                            else {
                                const res = resolveHeal(next.party[selectedTarget].curHp, next.party[selectedTarget].maxHp, hAmt, next.party[selectedTarget].shield);
                                next.party[selectedTarget].curHp = res.h; next.party[selectedTarget].shield = res.s;
                            }
                        }
                        triggerEffect(targetKey, skillId === 2 ? "REGEN" : `+${Math.ceil(hAmt)}`, 'heal');
                    } else if (skillId === 3) {
                        const targetKey = selectedTarget === 3 ? 'p-player' : `p-${selectedTarget}`;
                        if (selectedTarget !== 3 && next.party[selectedTarget].curHp <= 0) return prev;
                        triggerFlash(targetKey, 'shield');
                        const sVal = 400 * player.buffs.shieldMult;
                        if (selectedTarget === 3) next.playerShield = sVal; else next.party[selectedTarget].shield = sVal;
                        triggerEffect(targetKey, "SHIELD", "shield");
                    } else if (skillId === 4 || skillId === 6) {
                        next.party.forEach((m, idx) => { 
                            if (m.curHp > 0) {
                                const res = resolveHeal(m.curHp, m.maxHp, hAmt, m.shield);
                                m.curHp = res.h; m.shield = res.s;
                                triggerFlash(`p-${idx}`, 'heal'); triggerEffect(`p-${idx}`, `+${Math.ceil(hAmt)}`, 'heal'); 
                            }
                        });
                        const pRes = resolveHeal(next.playerCurHp, next.playerMaxHp, hAmt, next.playerShield);
                        next.playerCurHp = pRes.h; next.playerShield = pRes.s;
                        triggerFlash('p-player', 'heal'); triggerEffect('p-player', `+${Math.ceil(hAmt)}`, 'heal');
                    } else if (skillId === 8) {
                        const sVal = 550 * player.buffs.shieldMult;
                        next.party.forEach(m => { if (m.curHp > 0) { m.shield = sVal; triggerFlash(`p-${m.id}`, 'shield'); } });
                        next.playerShield = sVal;
                    }
                    return next;
                });
            }, [player, selectedTarget, addLog, triggerEffect, triggerFlash, showLoot]);

            const claimRewards = () => {
                setPlayer(p => {
                    let newExp = p.exp + 100;
                    let newLevel = p.level;
                    let newNextExp = p.nextLevelExp;
                    if (newExp >= newNextExp) {
                        newLevel += 1; newExp = 0; newNextExp = Math.floor(newNextExp * 1.7);
                    }
                    return { ...p, level: newLevel, exp: newExp, nextLevelExp: newNextExp, gold: p.gold + 500, skillPoints: p.skillPoints + 5 };
                });
                if (battleResult && battleResult.win && battleResult.loot) setInventory(old => [...old, ...battleResult.loot]);
                setView('LOBBY'); setLogs([]);
            };

            useEffect(() => {
                if (view === 'RAID' && raidData && !showLoot) {
                    gameLoopRef.current = setInterval(() => {
                        setRaidData(prev => {
                            if (!prev) return null;
                            const next = { ...prev };
                            const enemy = ENEMIES[next.stage - 1];
                            Object.keys(next.cooldowns).forEach(k => { if (next.cooldowns[k] > 0) next.cooldowns[k] -= (1 + player.buffs.cdReduction / 10); });
                            next.mana = Math.min(next.maxMana, next.mana + (1.2 * player.buffs.manaRegenMult));
                            next.party.forEach((m, i) => {
                                if (m.curHp <= 0) return;
                                if (m.hot > 0 && Math.random() < 0.1) {
                                    const tickH = 35 * player.buffs.healMult; m.curHp = Math.min(m.maxHp, m.curHp + tickH);
                                    triggerEffect(`p-${i}`, `+${Math.ceil(tickH)}`, 'heal'); m.hot -= 1;
                                }
                                const atkBonus = m.equipment.weapon?.stat === 'attack' ? m.equipment.weapon.value : 0;
                                m.attackProgress += (m.role === 'Tank' ? 5 : 10); 
                                if (m.attackProgress >= 100) {
                                    const dmg = (m.role === 'Tank' ? 200 : 750) + atkBonus;
                                    next.bossHp = Math.max(0, next.bossHp - dmg);
                                    triggerEffect('boss', `-${dmg}`, 'damage');
                                    triggerProjectile(`p-${i}`, 'boss', 'dps');
                                    m.attackProgress = 0;
                                }
                            });
                            const speedMult = difficulty === 'HARD' ? 1.3 : 0.7;
                            next.bossAttackProgress += 6 * speedMult;
                            next.bossSpecialProgress += enemy.specialSpeed * speedMult;
                            if (next.bossAttackProgress >= 100) {
                                const targets = [...next.party.map((_, idx) => idx), 'player'];
                                const valid = targets.filter(t => t === 'player' || next.party[t].curHp > 0);
                                if (valid.length === 0) return next;
                                const target = valid[Math.floor(Math.random() * valid.length)];
                                let rawDmg = Math.ceil(130 * (difficulty === 'HARD' ? 1.5 : 1.0) * (next.stage / 1.5));
                                if (target === 'player') {
                                    let actDmg = Math.max(0, rawDmg - next.playerShield); next.playerShield = Math.max(0, next.playerShield - rawDmg);
                                    next.playerCurHp = Math.max(0, next.playerCurHp - actDmg);
                                    triggerEffect('p-player', actDmg > 0 ? `-${actDmg}` : 'ABSORB', actDmg > 0 ? 'damage' : 'shield');
                                    triggerProjectile('boss', 'p-player', 'boss'); triggerShake();
                                } else {
                                    let actDmg = Math.max(0, rawDmg - next.party[target].shield); next.party[target].shield = Math.max(0, next.party[target].shield - rawDmg);
                                    next.party[target].curHp = Math.max(0, next.party[target].curHp - actDmg);
                                    triggerEffect(`p-${target}`, actDmg > 0 ? `-${actDmg}` : 'ABSORB', actDmg > 0 ? 'damage' : 'shield');
                                    triggerProjectile('boss', `p-${target}`, 'boss');
                                }
                                next.bossAttackProgress = 0;
                            }
                            if (next.bossSpecialProgress >= 100) {
                                addLog(`${enemy.name}Ïùò Í¥ëÏó≠ Í≥µÍ≤©!`, "error");
                                const aoe = 90 * next.stage;
                                next.party.forEach((m, idx) => { if (m.curHp > 0) { let actDmg = Math.max(0, aoe - m.shield); m.shield = Math.max(0, m.shield - aoe); m.curHp = Math.max(0, m.curHp - actDmg); triggerEffect(`p-${idx}`, actDmg > 0 ? `-${actDmg}` : 'ABSORB', 'damage'); } });
                                let pActDmg = Math.max(0, aoe - next.playerShield); next.playerShield = Math.max(0, next.playerShield - aoe);
                                next.playerCurHp = Math.max(0, next.playerCurHp - pActDmg);
                                triggerEffect('p-player', pActDmg > 0 ? `-${pActDmg}` : 'ABSORB', 'damage'); triggerShake();
                                next.bossSpecialProgress = 0;
                            }
                            if (next.bossHp <= 0) {
                                if (next.stage < next.maxStages) { handleMonsterDefeated(next.stage); return next; }
                                else { const finalLoot = [ITEM_POOLS[Math.floor(Math.random() * 4) + 6]]; endRaid(true, finalLoot); return prev; }
                            }
                            if (next.playerCurHp <= 0 || next.party.every(p => p.curHp <= 0)) { endRaid(false); return prev; }
                            return next;
                        });
                    }, 100);
                }
                return () => clearInterval(gameLoopRef.current);
            }, [view, difficulty, endRaid, triggerEffect, triggerProjectile, triggerShake, addLog, player.buffs, showLoot]);

            return (
                <div className={`min-h-screen bg-[#050505] text-neutral-100 overflow-y-auto select-none font-sans font-black ${isShaking ? 'shake' : ''}`}>
                    {screenFlash && <div className="fixed inset-0 bg-red-600/20 z-[300] pointer-events-none animate-pulse" />}
                    {showLoot && <LootOverlay upgrades={randomUpgrades} items={lootedItems} gold={lootedGold} onSelectUpgrade={applyUpgradeAndLoot} />}
                    {view === 'LOBBY' && <LobbyView player={player} setView={setView} setDifficulty={setDifficulty} difficulty={difficulty} startRaid={startRaidSession} />}
                    {view === 'RAID' && raidData && <RaidView raidData={raidData} combatEffects={combatEffects} projectiles={projectiles} player={player} selectedTarget={selectedTarget} setSelectedTarget={setSelectedTarget} castSpell={castSpell} logs={logs} flashes={flashes} />}
                    {view === 'RESULT' && battleResult && <ResultView battleResult={battleResult} claimRewards={claimRewards} />}
                    {view === 'SKILLS' && <SkillMenuView player={player} setPlayer={setPlayer} setView={setView} equipSkill={equipSkill} />}
                    {view === 'PARTY' && <PartyGearView party={party} inventory={inventory} setView={setView} onEquip={equipItem} onUnequip={unequipItem} />}
                    <div className="mt-20 py-10 opacity-20 text-[10px] text-neutral-500 font-black uppercase tracking-[0.6em] text-center border-t border-neutral-900 italic font-black font-black font-black font-black font-black">Simulation Kernel v16.1 // Protocol: GITHUB_PAGES_DEPLOY_STABLE</div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
